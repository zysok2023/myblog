# 网络模型
## 网络设计
第一层(物理层)-集线器:使用集线器进行多主机通信
![集线器](https://cdn.jsdelivr.net/gh/zysok2023/cloudImg/blogs/picture/集线器.gif)
A向B发送数据时只需要在头部指定源MAC地址和目标MAC地址就可以了，B 在收到数据包后，根据头部的目标 MAC 地址信息，判断这个数据包的确是发给自己的，于是便收下。虽然集线器使整个布局干净不少，但原来我只要发给电脑 B 的消息，现在却要发给连接到集线器中的所有电脑，这样既不安全，又不节省网络资源。
第二层(数据链路层)-交换机:在集线器的基础上进行改进，让源主机只将数据包只发给目标MAC地址指向的那台电脑，引入交换机。。
![交换机](https://cdn.jsdelivr.net/gh/zysok2023/cloudImg/blogs/picture/交换机.webp)
交换机内部维护一张 MAC 地址表，记录着每一个 MAC 地址的设备，连接在其哪一个端口上。
|MAC地址|	端口|
|----|---|
|bb-bb-bb-bb-bb-bb|	1|
|cc-cc-cc-cc-cc-cc|	3|
|aa-aa-aa-aa-aa-aa|	4|
|dd-dd-dd-dd-dd-dd|	5|

通过这样传输方式而组成的小范围的网络，叫做以太网。最开始的时候，MAC 地址表是空的，当一个设备通过端口连接到交换机时,交换机会观察该端口收到的第一个数据帧的源MAC地址,并将其记录到MAC地址表中,与该端口关联起来。如果目的MAC地址在地址表中找不到对应的输出端口,交换机会采用泛洪策略,将数据帧转发到除输入端口之外的所有端口。
![mac地址表学习](https://cdn.jsdelivr.net/gh/zysok2023/cloudImg/blogs/picture/mac地址表学习.gif)
随着机器数量越多，交换机的端口也不够了，将多个交换机连接起来。
![交换机串连](https://cdn.jsdelivr.net/gh/zysok2023/cloudImg/blogs/picture/交换机串连.webp)
最终，两个交换机将分别记录 A ~ H 所有机器的映射记录。
左边交换机
|MAC地址|端口|
|---|---|
|bb-bb-bb-bb-bb-bb|1|
|cc-cc-cc-cc-cc-cc|3|
|aa-aa-aa-aa-aa-aa|4|
|dd-dd-dd-dd-dd-dd|5|
|ee-ee-ee-ee-ee-ee|6|
|ff-ff-ff-ff-ff-ff|6|
|gg-gg-gg-gg-gg-gg|6|
|hh-hh-hh-hh-hh-hh|6|

右边交换机
|MAC地址|端口|
|---|---|
|bb-bb-bb-bb-bb-bb|1|
|cc-cc-cc-cc-cc-cc|1|
|aa-aa-aa-aa-aa-aa|1|
|dd-dd-dd-dd-dd-dd|1|
|ee-ee-ee-ee-ee-ee|2|
|ff-ff-ff-ff-ff-ff|3|
|gg-gg-gg-gg-gg-gg|4|
|hh-hh-hh-hh-hh-hh|6|
第三层(网络层)-路由器:接入一个新的设备，这个设备就跟电脑一样有自己独立的 MAC 地址，而且同时还能帮我把数据包做一次转发
![路由器webp](https://cdn.jsdelivr.net/gh/zysok2023/cloudImg/blogs/picture/路由器webp.webp)
**路由器的每一个端口，都有独立的 MAC 地址**
此时有一个问题，如何把发送给 C 和 D，甚至是把发送给 DEFGH.... 的数据包，统统先发送给路由器，这个时候光有mac地址就不够用了，这时候就引入了ip地址。通过软件层面来实现路由转发。
![加上ip地址的路由器](https://cdn.jsdelivr.net/gh/zysok2023/cloudImg/blogs/picture/加上ip地址的路由器.webp)
假如 A 给 B 发送数据，由于它们直接连着交换机，所以 A 直接发出如下数据包即可，其实网络层没有体现出作用。
但假如 A 给 C 发送数据，A 就需要先转交给路由器，然后再由路由器转交给 C。
由于最底层的传输仍然需要依赖以太网，所以数据包是分成两段的。
A ~ 路由器这段的包如下：
![A~路由器](https://cdn.jsdelivr.net/gh/zysok2023/cloudImg/blogs/picture/A~路由器.webp)

路由器到 C 这段的包如下：
![路由器~C](https://cdn.jsdelivr.net/gh/zysok2023/cloudImg/blogs/picture/路由器~C.webp)

默认网关，就是 A 在自己电脑里配置的一个 IP 地址，以便在发给不同子网的机器时，发给这个 IP 地址。
![不同网络通信](https://cdn.jsdelivr.net/gh/zysok2023/cloudImg/blogs/picture/不同网络通信.webp)

现在 A 要给 C 发数据包，已经可以成功发到路由器这里了，最后一个问题就是，路由器怎么知道，收到的这个数据包，该从自己的哪个端口出去，才能直接（或间接）地最终到达目的地 C 呢。路由器收到的数据包有目的 IP 也就是 C 的 IP 地址，需要转化成从自己的哪个端口出去，很容易想到，应该有个表，就像 MAC 地址表一样。这个表就叫路由表。
路由表的结构：
|目的地址|下一跳|端口|
|--|--|---|
|192.168.0.0/24||0|
|192.168.0.254/32||0|
|192.168.1.0/24||1|
|192.168.1.254/32||1|
路由表就表示，192.168.0.xxx 这个子网下的，都转发到 0 号端口，192.168.1.xxx 这个子网下的，都转发到 1 号端口。
**网络层（IP协议）本身没有传输包的功能，包的实际传输是委托给数据链路层（以太网中的交换机）来实现的。**
涉及到的三张表分别是:
- 交换机中有 MAC 地址表用于映射 MAC 地址和它的端口
- 路由器中有路由表用于映射 IP 地址(段)和它的端口,路由表是各种路由算法 + 人工配置逐步完善起来的。
- 电脑和路由器中都有arp缓存表用于缓存IP和MAC地址的映射关系,arp 缓存表是不断通过 arp 协议的请求逐步完善起来的。
![终极路由寻址](https://cdn.jsdelivr.net/gh/zysok2023/cloudImg/blogs/picture/终极路由寻址.gif)
如果路由器进行串联就涉及到了下一跳这个概念。
具体步骤：
1. 首先 A（192.168.0.1）通过子网掩码（255.255.255.0）计算出自己与 F（192.168.2.2）并不在同一个子网内，于是决定发送给默认网关（192.168.0.254）
2. A通过ARP找到默认网关192.168.0.254的 MAC 地址。
3. A 通过 ARP 找到 默认网关 192.168.0.254 的 MAC 地址。封装在网络层头部，然后发包
4. 交换机1收到数据包后，发现目标 MAC 地址是 ABAB，转发给路由器1
5. 数据包来到了路由器 1，发现其目标 IP 地址是 192.168.2.2，查看其路由表，发现了下一跳的地址是 192.168.100.5
6. 所以此时路由器 1 需要做两件事，第一件是再次匹配路由表，发现匹配到了端口为 2，于是将其封装到数据链路层，最后把包从 2 号口发出去。
7. 此时路由器 2 收到了数据包，看到其目的地址是 192.168.2.2，查询其路由表，匹配到端口号为 1，准备从 1 号口把数据包送出去。
8. 但此时路由器 2 需要知道 192.168.2.2 的 MAC 地址了，于是查看其 arp 缓存，找到其 MAC 地址为 FFFF，将其封装在数据链路层头部，并从 1 号端口把包发出去。
9. 交换机 3 收到了数据包，发现目的 MAC 地址为 FFFF，查询其 MAC 地址表，发现应该从其 6 号端口出去，于是从 6 号端口把数据包发出去。
10. F 最终收到了数据包！并且发现目的 MAC 地址就是自己，于是收下了这个包

## 网关
网关地址（通常称为默认网关）在网络配置中扮演着重要角色，通常用于将流量转发到不同的网络或子网。配置网关地址时，必须遵循一些基本原则和最佳实践，以确保网络通信的正常运行。
网关地址配置原则：
- 网关地址必须在同一子网内：默认网关的 IP 地址必须位于与客户端设备相同的子网中
- 网关地址应为路由器或三层交换机的 IP 地址
## 交换机和路由器
| 特性                  | 二层交换机                     | 三层交换机                     |
| ------------------- | -------------------------- | -------------------------- |
| 工作层次               | 数据链路层（Layer 2）          | 网络层（Layer 3）             |
| 转发基础               | MAC 地址                     | IP 地址                      |
| 路由功能               | 无                            | 有                            |
| VLAN 间路由            | 不支持                         | 支持                          |
| 主要用途               | 小型网络，接入层                | 中大型网络，汇聚层或核心层       |
| 广播域                 | 单一广播域                     | 多个广播域                     |


## IP
### 基本认识
ip在TCP/IP参考模型中处于第三层，也就是网络层。网络层的主要作用是实现主机与主机之间的通信。
ip的作用是在复杂的网络环境中将数据包发送给最终的主机。
**网络层和数据链路层的区别和联系**
ip的作用是实现主机与主机之间的通信，而MAC的作用是实现直连的两个设备之间的通信，而 IP 则负责在「没有直连」的两个网络之间进行通信传输。计算机网络中也需要「数据链路层」和「网络层」这个分层才能实现向最终目标地址的通信。源IP地址和目标IP地址在传输过程中是不会变化的（前提：没有使用 NAT 网络），只有源 MAC 地址和目标 MAC 一直在变化。
### ip地址的基础知识
在 TCP/IP 网络通信时，为了保证能正常通信，每个设备都需要配置正确的 IP 地址，否则无法实现正常的通信。IP 地址（IPv4 地址）由 32 位正整数来表示，IP 地址在计算机是以二进制的方式处理的。而人类为了方便记忆采用了**点分十进制**的标记方式，也就是将 32 位 IP 地址以每 8 位为组，共分为 4 组，每组以「.」隔开，再将每组转换成十进制，最大允许 43 亿台计算机连接到网络。实际上IP地址并不是根据主机台数来配置的，而是以网卡。像服务器、路由器等设备都是有 2 个以上的网卡，也就是它们会有 2 个以上的 IP 地址。
![ip与主机网卡路由器的关系](https://cdn.jsdelivr.net/gh/zysok2023/cloudImg/blogs/picture/ip与主机网卡路由器的关系.png)

#### ip地址的分类
IP 地址分类成了 5 种类型，分别是 A 类、B 类、C 类、D 类、E 类。
![IP分类](https://cdn.jsdelivr.net/gh/zysok2023/cloudImg/blogs/picture/IP分类.png)

- 主机号全为 1 指定某个网络下的所有主机，用于广播
- 主机号全为 0 指定某个网络
**广播地址用于在同一个链路中相互连接的主机之间发送数据包。**
广播地址可以分为本地广播和直接广播两种。
- 在本网络内广播的叫做本地广播。例如网络地址为 192.168.0.0/24 的情况下，广播地址是 192.168.0.255 。因为这个广播地址的 IP 包会被路由器屏蔽，所以不会到达 192.168.0.0/24 以外的其他链路上。
- 在不同网络之间的广播叫做直接广播。例如网络地址为 192.168.0.0/24 的主机向 192.168.1.255/24 的目标地址发送 IP 包。收到这个包的路由器，将数据转发给 192.168.1.0/24，从而使得所有 192.168.1.1~192.168.1.254 的主机都能收到这个包（由于直接广播有一定的安全问题，多数情况下会在路由器上设置为不转发。）。
![本地广播和直接广播](https://cdn.jsdelivr.net/gh/zysok2023/cloudImg/blogs/picture/本地广播和直接广播.png)

D 类和 E 类地址是没有主机号的，所以不可用于主机 IP，D 类常被用于多播，E 类是预留的分类，暂时未使用。多播用于将包发送给特定组内的所有主机。
![单播多播组播](https://cdn.jsdelivr.net/gh/zysok2023/cloudImg/blogs/picture/单播多播组播.png.png)

由于广播无法穿透路由，若想给其他网段发送同样的包，就可以使用可以穿透路由的多播。
多播使用的 D 类地址，其前四位是 1110 就表示是多播地址，而剩下的 28 位是多播的组编号。
从 224.0.0.0 ~ 239.255.255.255 都是多播的可用范围，其划分为以下三类：
- 224.0.0.0 ~ 224.0.0.255 为预留的组播地址，只能在局域网中，路由器是不会进行转发的。
- 224.0.1.0 ~ 238.255.255.255 为用户可用的组播地址，可以用于 Internet 上。
- 239.0.0.0 ~ 239.255.255.255 为本地管理组播地址，可供内部网在内部使用，仅在特定的本地范围内有效。
ip地址分类的优缺点：
- 优点就是简单明了、选路（基于网络地址）简单
- 缺点1就是同一网络下没有地址层次，缺少地址的灵活性。比如一个公司里用了 B 类地址，但是可能需要根据生产环境、测试环境、开发环境来划分地址层次，而这种 IP 分类是没有地址层次划分的功能
- 缺点2就是不能很好的与现实网络匹配，C 类地址能包含的最大主机数量实在太少了，只有 254 个

#### CIDR
CIDR(Classless Inter-Domain Routing):无类别域间路由 (CIDR) 是一种 IP地址分配方法，可提高互联网上的数据路由效率。每台连接到互联网的计算机、服务器和最终用户设备都有一个与之关联的唯一编号，称为 IP 地址。设备通过使用这些 IP 地址相互查找和通信。组织使用 CIDR 在其网络中灵活高效地分配 IP 地址。
![CIDR](https://cdn.jsdelivr.net/gh/zysok2023/cloudImg/blogs/picture/CIDR.png)

**这种方式不再有分类地址的概念，32 比特的 IP 地址被划分为两部分，前面是网络号，后面是主机号。**
表示形式 a.b.c.d/x，其中 /x 表示前 x 位属于网络号， x 的范围是 0 ~ 32，这就使得 IP 地址更加具有灵活性。比如 10.100.122.2/24，这种地址表示形式就是 CIDR，/24 表示前 24 位是网络号，剩余的 8 位是主机号。
还有另一种划分网络号与主机号形式，那就是子网掩码，掩码的意思就是掩盖掉主机号，剩余的就是网络号。将子网掩码和 IP 地址按位计算 AND，就可得到网络号。子网掩码还有一个作用，那就是划分子网。
两台计算机要通讯，首先要判断是否处于同一个广播域内，即网络地址是否相同。如果网络地址相同，表明接受方在本网络上，那么可以把数据包直接发送到目标主机。路由器寻址工作中，也就是通过这样的方式来找到对应的网络号的，进而把数据包转发给对应的网络内。
子网划分实际上是将主机地址分为两个部分：子网网络地址和子网主机地址。
![子网划分](https://cdn.jsdelivr.net/gh/zysok2023/cloudImg/blogs/picture/子网划分.webp)

### 公有ip地址和私有ip地址
在 A、B、C 分类地址，实际上有分公有 IP 地址和私有 IP 地址。
![私有IP地址](https://cdn.jsdelivr.net/gh/zysok2023/cloudImg/blogs/picture/私有IP地址.webp)

私有 IP 地址通常是内部的 IT 人员管理，公有 IP 地址是由 ICANN 组织管理，中文叫「互联网名称与数字地址分配机构」。
![公私ip](https://cdn.jsdelivr.net/gh/zysok2023/cloudImg/blogs/picture/公私ip.png)

IANA 是 ICANN 的其中一个机构，它负责分配互联网 IP 地址，是按州的方式层层分配。
![ip地址分配](https://cdn.jsdelivr.net/gh/zysok2023/cloudImg/blogs/picture/ip地址分配.png)
### ip地址与路由控制
IP地址的网络地址这一部分是用于进行路由控制。路由控制表中记录着网络地址与下一步应该发送至路由器的地址。在主机和路由器上都会有各自的路由器控制表。在发送 IP 包时，首先要确定 IP 包首部中的目标地址，再从路由控制表中找到与该地址具有相同网络地址的记录，根据该记录将 IP 包转发给相应的下一个路由器。如果路由控制表中存在多条相同网络地址的记录，就选择相同位数最多的网络地址，也就是最长匹配。
![网络链路](https://cdn.jsdelivr.net/gh/zysok2023/cloudImg/blogs/picture/网络链路.webp)

- 主机 A 要发送一个 IP 包，其源地址是 10.1.1.30 和目标地址是 10.1.2.10，由于没有在主机 A 的路由表找到与目标地址 10.1.2.10 相同的网络地址，于是包被转发到默认路由（路由器 1 ）
- 路由器 1 收到 IP 包后，也在路由器 1 的路由表匹配与目标地址相同的网络地址记录，发现匹配到了，于是就把 IP 数据包转发到了 10.1.0.2 这台路由器 2
- 路由器 2 收到后，同样对比自身的路由表，发现匹配到了，于是把 IP 包从路由器 2 的 10.1.2.1 这个接口出去，最终经过交换机把 IP 数据包转发到了目标主机
环回地址是在同一台计算机上的程序之间进行网络通信时所使用的一个默认地址。
计算机使用一个特殊的 IP 地址 127.0.0.1 作为环回地址。与该地址具有相同意义的是一个叫做 localhost 的主机名。使用这个 IP 或主机名时，数据包不会流向网络。

### ip分片和重组
每种数据链路的最大传输单元 MTU 都是不相同的，如 FDDI 数据链路 MTU 4352、以太网的 MTU 是 1500 字节等。
每种数据链路的 MTU 之所以不同，是因为每个不同类型的数据链路的使用目的不同。使用目的不同，可承载的 MTU 也就不同。
其中，我们最常见数据链路是以太网，它的 MTU 是 1500 字节。那么当 IP 数据包大小大于 MTU 时， IP 数据包就会被分片。经过分片之后的 IP 数据报在被重组的时候，只能由目标主机进行，路由器是不会进行重组的。
假设发送方发送一个 4000 字节的大数据报，若要传输在以太网链路，则需要把数据报分片成 3 个小数据报进行传输，再交由接收方重组成大数据报。
![分片和重组](https://cdn.jsdelivr.net/gh/zysok2023/cloudImg/blogs/picture/分片和重组.webp)

在分片传输中，一旦某个分片丢失，则会造成整个 IP 数据报作废，所以 TCP 引入了 MSS 也就是在 TCP 层进行分片不由 IP 层分片，那么对于 UDP 我们尽量不要发送一个大于 MTU 的数据报文。
### ip协议相关技术
与 IP 协议相关的重要且常见的技术如下：
- DNS 域名解析
DNS 域名解析，DNS 可以将域名网址自动转换为具体的 IP 地址。在域名中，越靠右的位置表示其层级越高。
域名的层级关系类似一个树状结构：根 DNS 服务器--顶级域 DNS 服务器（com）--权威 DNS 服务器（server.com）
根域名服务器的 IP 地址通常由 DNS 软件、DNS 递归解析器或操作系统中的默认 DNS 配置指定。
![DNS 域名解析的过程](https://cdn.jsdelivr.net/gh/zysok2023/cloudImg/blogs/picture/DNS 域名解析的过程.webp)
浏览器首先看一下自己的缓存里有没有，如果没有就向操作系统的缓存要，还没有就检查本机域名解析文件 hosts，如果还是没有，就会 DNS 服务器进行查询，查询的过程如下：
只有上级域名，才知道下一级域名的 IP 地址，需要逐级查询。当我们查询一个域名时，必须从根服务器开始，逐层查询，这就是所谓的 迭代查询 （ iterative query ）。
1. 先查询 根域名服务器
2. 根据根服务器返回结果，继续查询负责 .com 解析的服务器，一般叫做 顶级域名服务器(TLD top-level domain)
3. 根据顶级域名服务器返回结果，继续查询负责 fasionchan.com 解析的服务器，一般叫做 权威域名服务器
**DNS 域名解析的过程蛮有意思的，整个过程就和我们日常生活中找人问路的过程类似，只指路不带路。**
演示：
```shell
# 首先查询13个根域名服务器
dig
# 根据返回的根域名服务器选择一台服务器进行TLD顶级域名查询
dig @199.7.91.13 www.baidu.com
# 再从返回的TLD服务器中选择一台查询
dig @192.12.94.30 www.baidu.com
# 再从返回的一级域名服务器中选择一台查询
dig @220.181.33.31 www.baidu.com
# 最后返回结果
ANSWER SECTION
www.baidu.com.          1200    IN      CNAME   www.a.shifen.com.
```
DNS 服务器可以分成四种：根域名服务器、TLD 服务器、权威域名服务器、递归域名服务器
根域名服务器全世界一共有13台（都是服务器集群）
递归 DNS 服务器（recursive DNS server），可以自动递归查询。
一级域名服务器的正式名称叫做权威域名服务器（Authoritative Name Server，"权威"的意思是域名的 IP 地址由它给定。
- ARP 与 RARP 协议
在传输一个 IP 数据报的时候，确定了源 IP 地址和目标 IP 地址后，就会通过主机「路由表」确定 IP 数据包下一跳。然而，网络层的下一层是数据链路层，所以我们还要知道「下一跳」的 MAC 地址。由于主机的路由表中可以找到下一跳的 IP 地址，所以可以通过 ARP 协议，求得下一跳的 MAC 地址。ARP 是借助 ARP 请求与 ARP 响应两种类型的包确定 MAC 地址的。
1. 主机会通过广播发送 ARP 请求，这个包中包含了想要知道的 MAC 地址的主机 IP 地址。
2. 当同个链路中的所有设备收到 ARP 请求时，会去拆开 ARP 请求包里的内容，如果 ARP 请求包中的目标 IP 地址与自己的 IP 地址一致，那么这个设备就将自己的 MAC 地址塞入 ARP 响应包返回给主机。
ARP 协议是已知 IP 地址求 MAC 地址，那 RARP 协议正好相反，它是已知 MAC 地址求 IP 地址。例如将打印机服务器等小型嵌入式设备接入到网络时就经常会用得到。
![RARP](https://cdn.jsdelivr.net/gh/zysok2023/cloudImg/blogs/picture/RARP.webp)


- DHCP 动态获取 IP 地址
![DHCP](https://cdn.jsdelivr.net/gh/zysok2023/cloudImg/blogs/picture/DHCP.webp)
![DHCP中继代理](https://cdn.jsdelivr.net/gh/zysok2023/cloudImg/blogs/picture/DHCP 中继代理.webp)
- NAT 网络地址转换
简单的来说 NAT 就是同个公司、家庭、教室内的主机对外部通信时，把私有 IP 地址转换成公有 IP 地址。
![NAT](https://cdn.jsdelivr.net/gh/zysok2023/cloudImg/blogs/picture/NAT.webp)
![NAPT](https://cdn.jsdelivr.net/gh/zysok2023/cloudImg/blogs/picture/NAPT.webp)
1. 外部无法主动与 NAT 内部服务器建立连接，因为 NAPT 转换表没有转换记录
2. 转换表的生成与转换操作都会产生性能开销。
3. 通信过程中，如果 NAT 路由器重启了，所有的 TCP 连接都将被重置。
解决的方法主要有两种方法。第一种就是改用 IPv6;第二种 NAT 穿透技术
- ICMP 互联网控制报文协议
ICMP 全称是 Internet Control Message Protocol，也就是互联网控制报文协议。
ICMP 主要的功能包括：确认 IP 包是否成功送达目标地址、报告发送过程中 IP 包被废弃的原因和改善网络设置等。
在 IP 通信中如果某个 IP 包因为某种原因未能达到目标地址，那么这个具体的原因将由 ICMP 负责通知。
![icmp](https://cdn.jsdelivr.net/gh/zysok2023/cloudImg/blogs/picture/icmp.webp)

ICMP 大致可以分为两大类：一类是用于诊断的查询消息，也就是「查询报文类型」,另一类是通知出错原因的错误消息，也就是「差错报文类型」
![ICMP类型](https://cdn.jsdelivr.net/gh/zysok2023/cloudImg/blogs/picture/ICMP类型.webp)


- IGMP 因特网组管理协议
由于 NAT/NAPT 都依赖于自己的转换表，因此会有以下的问题：
。

互联网的本质就是一系列的网络协议，这个协议就叫OSI协议（一系列协议），按照功能不同，分工不同，人为的分层七层。
记忆口诀：
- 物联网，传输应用（五层）
- 物联网传话，表示应用（七层）
- please do not tell stupid people anything
![OSI七层模型](https://cdn.jsdelivr.net/gh/zysok2023/cloudImg/blogs/picture/OSI七层模型.gif)

应用层传输的是消息或报文(message)
传输层传输的是段(segment)
网络层传输的是包(packet)
网络接口层传输的是帧(frame)
统称为数据包。




## 应用层
应用层只需要专注于为用户提供应用功能，比如 HTTP、FTP、Telnet、DNS、SMTP等。
应用层是工作在操作系统中的用户态，传输层及以下则工作在内核态。
应用层是不用去关心数据是如何传输的。
## 传输层
应用层的数据包会传给传输层，传输层（Transport Layer）是为应用层提供网络支持的。
在传输层会有两个传输协议，分别是 TCP 和 UDP。
TCP 的全称叫传输控制协议（Transmission Control Protocol），大部分应用使用的正是 TCP 传输层协议，比如 HTTP 应用层协议。TCP 相比 UDP 多了很多特性，比如流量控制、超时重传、拥塞控制等，这些都是为了保证数据包能可靠地传输给对方。
UDP 相对来说就很简单，简单到只负责发送数据包，不保证数据包是否能抵达对方，但它实时性相对更好，传输效率也高。当然，UDP 也可以实现可靠传输，把 TCP 的特性在应用层上实现就可以，不过要实现一个商用的可靠 UDP 传输协议，也不是一件简单的事情。
应用需要传输的数据可能会非常大，如果直接传输就不好控制，因此当传输层的数据包大小超过 MSS（TCP 最大报文段长度） ，就要将数据包分块，这样即使中途有一个分块丢失或损坏了，只需要重新发送这一个分块，而不用重新发送整个数据包。在 TCP 协议中，我们把每个分块称为一个 TCP 段（TCP Segment）。
当设备作为接收方时，传输层则要负责把数据包传给应用，但是一台设备上可能会有很多应用在接收或者传输数据，因此需要用一个编号将应用区分开来，这个编号就是**端口**。
由于传输层的报文中会携带端口号，因此接收方可以识别出该报文是发送给哪个应用。
## 网络层
传输层可能大家刚接触的时候，会认为它负责将数据从一个设备传输到另一个设备，事实上它并不负责。
网络层最常使用的是 IP 协议（Internet Protocol），IP 协议会将传输层的报文作为数据部分，再加上 IP 包头组装成 IP 报文，如果 IP 报文大小超过 MTU（以太网中一般为 1500 字节）就会再次进行分片，得到一个即将发送到网络的 IP 报文。
网络层负责将数据从一个设备传输到另一个设备，世界上那么多设备，又该如何找到对方呢？因此，网络层需要有区分设备的编号。只有一个单纯的 IP 地址虽然做到了区分设备，但是寻址起来就特别麻烦，全世界那么多台设备，难道一个一个去匹配？这显然不科学。因此，需要将 IP 地址分成两种意义：
- 一个是网络号，负责标识该 IP 地址是属于哪个「子网」的；
- 一个是主机号，负责标识同一「子网」下的不同主机；

将IP地址和子网掩码进行按位与运算，就可以得到网络号
将IP地址和子网掩码的取反值进行按位与运算，就可以得到主机号
主机号位全是1的地址为此网段的广播地址，全是0时表示该网络的网络号
在寻址的过程中，先匹配到相同的网络号（表示要找到同一个子网），才会去找对应的主机.
除了寻址能力， IP 协议还有另一个重要的能力就是路由。实际场景中，两台设备并不是用一条网线连接起来的，而是通过很多网关、路由器、交换机等众多网络设备连接起来的，那么就会形成很多条网络的路径，因此当数据包到达一个网络节点，就需要通过路由算法决定下一步走哪条路径。路由器寻址工作中，就是要找到目标地址的子网，找到后进而把数据包转发给对应的网络内。

## 网络接口层
生成了 IP 头部之后，接下来要交给网络接口层（Link Layer）在 IP 头部的前面加上 MAC 头部，并封装成数据帧（Data frame）发送到网络上。
电脑上的以太网接口，Wi-Fi接口，以太网交换机、路由器上的千兆，万兆以太网口，还有网线，它们都是以太网的组成部分。以太网就是一种在「局域网」内，把附近的设备连接起来，使它们之间可以进行通讯的技术。
以太网在判断网络包目的地时和 IP 的方式不同，因此必须采用相匹配的方式才能在以太网中将包发往目的地，而 MAC 头部就是干这个用的，所以，在以太网进行通讯要用到 MAC 地址。
MAC 头部是以太网使用的头部，它包含了接收方和发送方的 MAC 地址等信息，我们可以通过 ARP 协议获取对方的 MAC 地址。
网络接口层主要为网络层提供「链路级别」传输的服务，负责在以太网、WiFi 这样的底层网络上发送原始数据包，工作在网卡这个层次，使用 MAC 地址来标识网络上的设备。












